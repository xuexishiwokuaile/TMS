
@{
    ViewBag.Title = "Repair";
}
@*CreatedBy 李虎*@
<div style="margin-left:20px;margin-top:20px;">
    <span class="layui-breadcrumb">
        <a href="../Home/Index"><i class="layui-icon layui-icon-home"></i>首页</a>
        <a><cite>报修</cite></a>
        <a><cite>报修申请</cite></a>
    </span>
</div>

<br />
<br />


<div class="layui-inline" id="searchKeyword" style="margin-left:5px;">
    <input type="text" autocomplete="off" id="keyword" placeholder="夹具代码..." class="layui-input">
</div>
<div class="layui-btn-group inoutTable">
    <button id="searchRepairOrder" data-type="reload" class="layui-btn layui-btn-radius demo" style="background-color:#009688;margin-left:20px;"><i class="layui-icon layui-icon-search"></i>查询申请</button>
    <button id="addRepairOrder" class="layui-btn layui-btn-radius demo" style="background-color:#FF9800;margin-left:20px;"><i class="layui-icon layui-icon-addition"></i>提交申请</button>
    <button id="batchDel" class="layui-btn layui-btn-radius" style="background-color:#FF5157;margin-left:20px;"><i class="layui-icon layui-icon-subtraction"></i>删除申请</button>
</div>
<br />

<script type="text/html" id="tbar">
    @*<button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="Edit"><i class="layui-icon"></i> 修改</button>*@
    <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="Del"><i class="layui-icon"></i> 撤销</button>
</script>

<style>
    .layui-table-cell .layui-form-checkbox[lay-skin="primary"] {
        transform: translateY(20%);
    }
</style>
<!--layui.table图片显示不全，需重新定义CSS  -->
<style type="text/css">
    .layui-table-cell {
        height: auto !important;
        white-space: normal;
    }
</style>

@*数据表*@
<table class="layui-table" id="repairOrderTable" lay-filter="jsTabel"></table>
@Styles.Render("~/Content/css")
<script type="text/javascript">

    layui.use('table', function () {
        var table = layui.table;
        var $ = layui.$;
        var form = layui.form;
        table.render({
            elem: '#repairOrderTable'
            , height: 510
            , url: "@Url.Action("GetRepairOrderList","ToolManage")"//数据接口
            , page: true //开启分页
             , where: { keyword: $("#keyword").val() }
            , cols: [[
                { type: "checkbox" },
                { field: 'proposerName', title: '申请人', width: 150, sort: true },
                //{ field: 'proposerId', title: '申请人id', width: 150, sort: true },
                //已被code代替
                //{ field: 'toolId', title: '夹具id', width: 150, sort: true },
                { field: 'code', title: '夹具代码', width: 150, sort: true },
                { field: 'seqId', title: '夹具序列号', width: 100, sort: true },
                { field: 'dealerId', title: '处理人id', width: 150, sort: true },
                //{ field: 'faultPicUrl', title: '问题图片url', width: 150, sort: true },
                { field: 'description', title: '问题描述', width: 150, sort: true },
                {
                    field: 'faultPicUrl', title: '问题图片', align: 'center', templet: function (d) {
                        return '<div onclick="show_img(this)" ><img src="'+d.faultPicUrl+'" alt="" width="100px" height="100px"></a></div>';
                    }
                },
                {
                    field: 'state', title: '申请状态', width: 150, sort: true, templet: function (obj) {
                        if (obj.state == -1) {
                            return '已提交申请';
                        } else if (obj.state == 0) {
                            return '已通过申请';
                        } else if (obj.state == 1) {
                            return '未通过终审';
                        }
                    }
                },
                { title: '操作', width: 100, toolbar: "#tbar" }
            ]]
        });

        //显示大图片
        window.show_img = function(t) {
            var t = $(t).find("img");
            //页面层
            layer.open({
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                 area: ['80%', '80%'], //宽高
                shadeClose: true, //开启遮罩关闭
                end: function (index, layero) {
                    return false;
                },
                content: '<div style="text-align:center"><img src="' + $(t).attr('src') + '" /></div>'
            });
        }

        $("#addRepairOrder").on("click", function () {
            layer.open({
                type: 2,
                content: '@Url.Action("RepairOrderDetail","ToolManage")',
                title: "添加类别",
                area: ["500px", "500px"],
                end: function () { // layui 关闭弹框时的回调函数
                    $("#searchRepairOrder").click();
                }
            })
        })

        $("#searchRepairOrder").on("click", function () {
            console.log($("#keyword").val());
            table.reload("repairOrderTable", {
                url:"@Url.Action("GetRepairOrderList","ToolManage")",
                page: { curr: 1 },
                where: {
                    keyword:$("#keyword").val()
                }
            });
        })

        $("#batchDel").on("click", function () {
            var selectedobjs = table.checkStatus("repairOrderTable").data;
            console.log(selectedobjs);

                //var userGuids = [];
                //$(selectedobjs).each(function (index, item) {
                //    userGuids.push(item.UserGuid);
                //})

            var repairIds = selectedobjs.map(function (item) {
                return item.repairOrderId;
            })


            if (!repairIds || repairIds.length <= 0) {
                    return false;
            }


                layer.confirm("确认批量删除吗？", function () {

                    layer.load(5, { shade: [0.5, "#5588AA"] });
                      $.ajax({
                        type: "POST",
                        url: "@Url.Action("BatchDelRepairOrders","ToolManage")",
                        data: { repairIds: repairIds },
                        success: function (result) {
                            layer.closeAll();
                            if (result.Success) {
                                $("#searchRepairOrder").click();
                                layer.msg(result.Message, {icon:1});
                            }
                            else
                            {
                                layer.msg(result.Message, { icon:5 });
                            }
                        }
                    })
                })
            })

        table.on("tool(jsTabel)", function (obj) {
            var event = obj.event;
            var data = obj.data;

            @*if (event == "Edit") {
                layer.open({
                    type: 2,
                    content: '@Url.Action("PurchaseOrderDetail")?repairId=' + data.repairId,
                    title: "修改采购申请",
                    area: ["500px", "500px"],
                    end: function () { // layui 关闭弹框时的回调函数
                        $("#searchPurchaseOrder").click();
                    }
                })

            } else*@ if (event = "Del") {
                console.log(data);
                var repairId = data.repairOrderId;
                layer.confirm("确认删除吗？", function () {
                    layer.load(5, { shade: [0.5, "#5588AA"] });
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("DelRepairOrder","ToolManage")",
                        data: { repairId: repairId },
                        success: function (result) {
                            layer.closeAll();
                            if (result.Success) {
                                $("#searchRepairOrder").click();
                                layer.msg(result.Message, { icon: 1 });
                            }
                            else {
                                layer.msg(result.Message, { icon: 5 });
                            }
                        }
                    })
                })

            }
        })
    });
</script>
<div id="pagesplit" style="margin:auto auto auto 200px;"></div>





