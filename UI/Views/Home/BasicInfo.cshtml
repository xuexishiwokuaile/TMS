
@{
    ViewBag.Title = "BasicInfo";
}

<div style="margin-left:20px;margin-top:20px;">
    <span class="layui-breadcrumb">
        <a href="../Home/Index"><i class="layui-icon layui-icon-home"></i>首页</a>
        <a><cite>夹具管理</cite></a>
        <a><cite>夹具信息管理</cite></a>
    </span>
</div>
<br />
<br />
@*search*@



<div class="layui-inline" id="searchKeyword" style="margin-left:5px;">
    <input type="text" autocomplete="off" id="keyword" placeholder="代码..." class="layui-input">
</div>
<div class="layui-btn-group inoutTable">
    <button id="searchTool" data-type="reload" class="layui-btn layui-btn-normal" style="margin-left:20px;"><i class="layui-icon layui-icon-search"></i>查询类别</button>
    @*<button id="batchInTool" class="layui-btn" style="margin-left:20px;"><i class="layui-icon layui-icon-addition"></i>批量入库</button>
        <button id="batchOutTool" class="layui-btn layui-btn-danger" style="margin-left:20px;"><i class="layui-icon layui-icon-subtraction"></i>批量出库</button>*@
    <button id="newTool" class="layui-btn layui-btn-primary" style="margin-left:20px;"><i class="layui-icon layui-icon-subtraction"></i>新增夹具</button>
    <button id="deleteTool" class="layui-btn layui-btn-warm" style="margin-left:20px;"><i class="layui-icon layui-icon-subtraction"></i>删除夹具</button>
</div>
<br />

<script type="text/html" id="tbar">
    @*{{# if(d._out){}}
        <button class="layui-btn layui-btn-sm" lay-event="In">入库</button>
        {{# }else{ }}
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="Out">出库</button>
        {{# }}}*@
    <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="Edit">编辑</button>
</script>
<!--layui.table图片显示不全，需重新定义CSS  -->
<style type="text/css">
    .layui-table-cell {
        height: auto !important;
        white-space: normal;
    }
</style>
<style>
    .layui-table-cell .layui-form-checkbox[lay-skin="primary"] {
        transform: translateY(20%);
    }
</style>

@*数据表*@
<table class="layui-table" id="toolTable" lay-filter="jsTabel"></table>
@Styles.Render("~/Content/css")
<script type="text/javascript">

    layui.use('table', function () {
        var table = layui.table;
        var $ = layui.$;
        var form = layui.form;
        table.render({
            elem: '#toolTable'
            , height: 510
            , url: "@Url.Action("GetToolList","ToolManage")"//数据接口
            , page: true //开启分页
             , where: { keyword: $("#keyword").val() }
            , cols: [[
                { type:"checkbox" },
                //{ field: 'toolId', title: '夹具id', width: 100, sort: true },
                //被code代替
                //{ field: 'typeId', title: '种类id（后改为code）', width: 150, sort: true },
                { field: 'code', title: '夹具代码', width: 150, sort: true },
                { field: 'seqId', title: '序列号', width: 100, sort: true },
                { field: 'billNo', title: '采购单据号', width: 130, sort: true },
                { field: 'operatorId', title: '经办人id', width: 100, sort: true },
                { field: 'regDate', title: '入库日期', width: 80, sort: true,templet: function(d){ return toDateString(d.regDate); } },
                { field: 'location', title: '存放库位', width: 110, sort: true },
                { field: 'proDate', title: '生产日期', width: 80, sort: true,templet: function(d){ return toDateString(d.proDate); }  },
                {
                    field: 'picUrl', title: '问题图片', align: 'center', width: 200, templet: function (d) {
                        return '<div onclick="show_img(this)" ><img src="'+d.picUrl+'" alt="" width="100px" ></a></div>';
                    }
                },
                { field: 'usedCount', title: '已用次数', width: 50, sort: true },
                {
                    title: '状态', width: 120, sort: true, sort: true, templet: function (obj) {
                        if (obj._out) {
                            return '<i class="layui-icon layui-icon-face-surprised" style="color: #FF5722;">  已出库</i>';
                        } else {
                            return '<i class="layui-icon layui-icon-face-smile" style="color: #009688;">  在库中</i>';
                        }
                    }
                },
                { title: '操作', width: 300, toolbar: "#tbar" }
            ]]
        });

        //显示大图片
        window.show_img = function(t) {
            var t = $(t).find("img");
            //页面层
            layer.open({
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                 area: ['80%', '80%'], //宽高
                shadeClose: true, //开启遮罩关闭
                end: function (index, layero) {
                    return false;
                },
                content: '<div style="text-align:center"><img src="' + $(t).attr('src') + '" /></div>'
            });
        }

		//日期格式转换
		function toDateString(d)
		{
			var date = new Date(parseInt(d.replace("/Date(", "").replace(")/", ""), 10));
			var y = date.getFullYear();
			var m = date.getMonth()+1;
			m = m<10?'0'+m:m;
			var d = date.getDate();
			d = d<10?("0"+d):d;
			var str = y+"-"+m+"-"+d;
			return str;
		}


        $("#searchTool").on("click", function () {
            console.log($("#keyword").val());
            table.reload("toolTable", {
                page: { curr: 1 },
                where: {
                    keyword:$("#keyword").val()
                }
            });
        })

        $("#newTool").on("click", function () {
            layer.open({
                type: 2,
                content: '@Url.Action("newToolDetail","ToolManage")',
                title: "新增夹具信息",
                area: ["650px", "730px"],
                end: function () { // layui 关闭弹框时的回调函数
                    layer.closeAll();
                    $("#searchTool").click();
                }
            })
        })

         $("#deleteTool").on("click", function () {
            var selectedobjs = table.checkStatus("toolTable").data;

            var toolIds = selectedobjs.map(function (item) {
                return item.toolId;
            })
            //console.log(typeIds);

            if (!toolIds || toolIds.length <= 0) {
                    return false;
                }
                layer.confirm("确认批量删除吗？", function () {

                    layer.load(5, { shade: [0.5, "#5588AA"] });
                      $.ajax({
                        type: "POST",
                        url: "@Url.Action("BatchDeleteTools","ToolManage")",
                        data: { toolIds: toolIds },
                        success: function (result) {
                            layer.closeAll();
                            if (result.Success) {
                                $("#searchTool").click();
                                layer.msg(result.Message, {icon:1});
                            }
                            else
                            {
                                layer.msg(result.Message, { icon:5 });
                            }
                        }
                    })
                })
            })

        table.on("tool(jsTabel)", function (obj) {
            var event = obj.event;
            var data = obj.data;

            if (event == "Edit") {//编辑
                console.log(data.toolId);
                layer.open({
                    type: 2,
                    content: '@Url.Action("editToolDetail","ToolManage")?toolId=' + data.toolId,
                    title: "修改夹具信息",
                    area: ["650px", "730px"],
                    end: function () { // layui 关闭弹框时的回调函数
                        $("#searchTool").click();
                    }
                })
            }

        })
    });
</script>
<div id="pagesplit" style="margin:auto auto auto 200px;"></div>





